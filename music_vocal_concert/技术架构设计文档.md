# Music Vocal Concert 技术架构设计文档

## 1. 总体架构

### 1.1 架构概述
Music Vocal Concert采用微服务架构，采用前后端分离的设计模式，实现高可用、可扩展的系统架构。

### 1.2 架构图
```
+-------------------+     +-------------------+     +-------------------+
|   用户浏览器      |     |   负载均衡器      |     |   API网关         |
|   (React前端)     |<--->|   (Nginx)         |<--->|   (FastAPI)       |
+-------------------+     +-------------------+     +-------------------+
                                                         |
                                                         v
                                              +-----------------------+
                                              |   业务服务层           |
                                              |   (ConcertService)    |
                                              +-----------------------+
                                                         |
                                                         v
                                              +-----------------------+
                                              |   数据访问层           |
                                              |   (SQLAlchemy)        |
                                              +-----------------------+
                                                         |
                  +------------------+------------------+------------------+
                  |                  |                  |                  |
         +--------+--------+ +-----+--------+ +-------+--------+ +--------+-------+
         |   PostgreSQL    | |   MongoDB    | |   Redis        | |   文件存储     |
         |   (关系型)      | |   (文档型)   | |   (缓存)       | |   (图片等)     |
         +-----------------+ +--------------+ +----------------+ +----------------+
```

### 1.3 技术栈选择

#### 1.3.1 前端技术栈
- **框架**: React.js + TypeScript
- **状态管理**: Redux Toolkit
- **路由**: React Router
- **样式**: Styled Components + CSS Modules
- **构建工具**: Webpack + Babel
- **测试**: Jest + React Testing Library

#### 1.3.2 后端技术栈
- **Web框架**: FastAPI + Python 3.9+
- **数据库**: PostgreSQL + MongoDB
- **ORM**: SQLAlchemy + PyMongo
- **缓存**: Redis
- **消息队列**: Celery + RabbitMQ
- **部署**: Docker + Kubernetes

#### 1.3.3 基础设施
- **容器化**: Docker
- **编排**: Kubernetes
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack
- **CI/CD**: GitLab CI + Jenkins

## 2. 详细架构设计

### 2.1 前端架构

#### 2.1.1 组件结构
```
src/
├── components/
│   ├── common/           # 通用组件
│   │   ├── Button/
│   │   ├── Input/
│   │   ├── Modal/
│   │   └── Loading/
│   ├── concert/          # 演唱会相关组件
│   │   ├── ConcertList/
│   │   ├── ConcertCard/
│   │   ├── ConcertDetail/
│   │   └── ConcertFilter/
│   ├── user/             # 用户相关组件
│   │   ├── Login/
│   │   ├── Register/
│   │   └── Profile/
│   └── layout/           # 布局组件
│       ├── Header/
│       ├── Footer/
│       └── Sidebar/
├── pages/                # 页面组件
│   ├── Home/
│   ├── Concerts/
│   ├── Search/
│   ├── Profile/
│   └── Statistics/
├── hooks/                # 自定义Hook
├── services/             # API服务
├── store/                # Redux Store
├── utils/                # 工具函数
└── styles/               # 全局样式
```

#### 2.1.2 状态管理
- **Redux Store**: 全局状态管理
- **Redux Toolkit**: 简化Redux开发
- **Redux Persist**: 状态持久化
- **Redux Thunk**: 异步操作处理

#### 2.1.3 数据流
```
用户操作 -> Action -> Reducer -> Store更新 -> 组件重新渲染
```

### 2.2 后端架构

#### 2.2.1 服务分层
```
+-------------------+
|     API层         |
|   (FastAPI路由)   |
+-------------------+
         |
         v
+-------------------+
|   业务逻辑层      |
| (ConcertService)  |
+-------------------+
         |
         v
+-------------------+
|   数据访问层      |
|   (SQLAlchemy)    |
+-------------------+
         |
         v
+-------------------+
|     数据库        |
| (PostgreSQL)      |
+-------------------+
```

#### 2.2.2 核心服务
- **ConcertService**: 演唱会业务服务
- **DataService**: 数据服务
- **ScraperService**: 数据抓取服务
- **UserService**: 用户服务
- **AuthService**: 认证服务

#### 2.2.3 数据库设计
```sql
-- 演唱会表
CREATE TABLE concerts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    artist VARCHAR(100) NOT NULL,
    city VARCHAR(50) NOT NULL,
    region VARCHAR(20) NOT NULL,
    date TIMESTAMP NOT NULL,
    address VARCHAR(300) NOT NULL,
    venue VARCHAR(100) NOT NULL,
    platform VARCHAR(50) NOT NULL,
    price_range VARCHAR(50),
    duration INTEGER,
    concert_type VARCHAR(50),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户收藏表
CREATE TABLE user_favorites (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    concert_id INTEGER REFERENCES concerts(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.3 数据抓取架构

#### 2.3.1 抓取流程
```
数据源 -> 抓取器 -> 解析器 -> 验证器 -> 存储器 -> 通知器
```

#### 2.3.2 抓取器设计
- **平台适配器**: 每个平台的独立抓取器
- **并发控制**: 控制抓取并发数量
- **错误处理**: 自动重试和错误记录
- **状态监控**: 实时抓取状态监控

#### 2.3.3 解析器设计
- **HTML解析**: BeautifulSoup + lxml
- **JSON解析**: 直接解析API响应
- **数据验证**: 验证数据完整性和准确性
- **数据清洗**: 清理和格式化数据

### 2.4 缓存架构

#### 2.4.1 缓存策略
- **Redis缓存**: 热点数据缓存
- **CDN缓存**: 静态资源缓存
- **浏览器缓存**: 客户端缓存

#### 2.4.2 缓存层级
```
用户请求 -> Redis缓存 -> 数据库查询 -> 结果缓存
```

### 2.5 监控架构

#### 2.5.1 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: 响应时间、错误率、吞吐量
- **业务指标**: 用户活跃度、数据量、抓取成功率

#### 2.5.2 监控工具
- **Prometheus**: 指标收集
- **Grafana**: 可视化展示
- **Alertmanager**: 告警管理
- **ELK Stack**: 日志收集和分析

## 3. 部署架构

### 3.1 容器化部署

#### 3.1.1 Docker镜像
```dockerfile
# 前端镜像
FROM node:16-alpine as frontend-builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 后端镜像
FROM python:3.9-slim as backend-builder
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .

# 最终镜像
FROM nginx:alpine
COPY --from=frontend-builder /app/build /usr/share/nginx/html
COPY --from=backend-builder /app /app
```

#### 3.1.2 Docker Compose
```yaml
version: '3.8'
services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "3000:3000"
    depends_on:
      - api

  api:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/music_vocal_concert
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=music_vocal_concert
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 3.2 Kubernetes部署

#### 3.2.1 部署配置
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: music-vocal-concert-frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: music-vocal-concert-frontend
  template:
    metadata:
      labels:
        app: music-vocal-concert-frontend
    spec:
      containers:
      - name: frontend
        image: music-vocal-concert-frontend:latest
        ports:
        - containerPort: 3000
        resources:
          limits:
            memory: "128Mi"
            cpu: "100m"
---
apiVersion: v1
kind: Service
metadata:
  name: music-vocal-concert-frontend
spec:
  selector:
    app: music-vocal-concert-frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
  type: LoadBalancer
```

### 3.3 云部署

#### 3.3.1 AWS部署
- **EC2**: 应用服务器
- **RDS**: PostgreSQL数据库
- **ElastiCache**: Redis缓存
- **S3**: 静态资源存储
- **CloudFront**: CDN加速

#### 3.3.2 阿里云部署
- **ECS**: 应用服务器
- **RDS**: PostgreSQL数据库
- **ElastiCache**: Redis缓存
- **OSS**: 静态资源存储
- **CDN**: 内容分发网络

## 4. 安全架构

### 4.1 网络安全
- **防火墙**: 安全组配置
- **WAF**: Web应用防火墙
- **DDoS防护**: 分布式拒绝服务防护
- **SSL/TLS**: HTTPS加密传输

### 4.2 应用安全
- **身份认证**: JWT + OAuth2
- **权限控制**: RBAC权限模型
- **数据加密**: 敏感数据加密存储
- **输入验证**: 防止SQL注入、XSS攻击

### 4.3 数据安全
- **数据备份**: 定期备份和恢复
- **数据加密**: 存储和传输加密
- **访问控制**: 严格的访问权限管理
- **审计日志**: 完整的操作日志记录

## 5. 性能优化

### 5.1 前端优化
- **代码分割**: 按需加载
- **图片优化**: 图片压缩和懒加载
- **缓存策略**: 浏览器缓存和CDN缓存
- **代码优化**: 减少bundle大小

### 5.2 后端优化
- **数据库优化**: 索引优化、查询优化
- **缓存优化**: Redis缓存策略
- **异步处理**: 异步任务处理
- **连接池**: 数据库连接池

### 5.3 系统优化
- **负载均衡**: 多节点负载均衡
- **水平扩展**: 支持多节点部署
- **监控优化**: 性能监控和调优
- **资源优化**: 资源利用优化

## 6. 灾备方案

### 6.1 数据备份
- **数据库备份**: 每日全量备份，每小时增量备份
- **文件备份**: 静态资源备份
- **配置备份**: 系统配置备份

### 6.2 故障恢复
- **主从切换**: 数据库主从切换
- **服务降级**: 服务降级策略
- **自动恢复**: 自动故障检测和恢复
- **人工干预**: 人工故障处理流程

### 6.3 灾难恢复
- **异地备份**: 异地数据备份
- **恢复演练**: 定期恢复演练
- **应急预案**: 详细的应急预案
- **团队协作**: 应急响应团队协作

## 7. 运维监控

### 7.1 监控体系
- **系统监控**: CPU、内存、磁盘、网络
- **应用监控**: 响应时间、错误率、吞吐量
- **业务监控**: 用户活跃度、数据量、抓取成功率
- **安全监控**: 安全事件监控

### 7.2 告警体系
- **告警规则**: 基于阈值的告警规则
- **告警通知**: 邮件、短信、微信通知
- **告警处理**: 告警处理流程
- **告警优化**: 告警规则优化

### 7.3 日志管理
- **日志收集**: 集中式日志收集
- **日志分析**: 日志分析和挖掘
- **日志存储**: 日志存储和归档
- **日志查询**: 日志查询和检索

## 8. 附录

### 8.1 技术选型依据
- **FastAPI**: 高性能、异步支持、自动生成API文档
- **React**: 组件化开发、丰富的生态系统
- **PostgreSQL**: 关系型数据库，支持JSON、GIS等高级特性
- **MongoDB**: 文档型数据库，灵活的数据模型
- **Redis**: 高性能缓存，支持多种数据结构

### 8.2 架构演进
- **初期**: 单体应用，简单部署
- **中期**: 微服务架构，服务拆分
- **后期**: 云原生架构，容器化部署
- **未来**: 无服务器架构，Serverless

### 8.3 技术债务管理
- **代码规范**: 统一的代码规范
- **重构计划**: 定期重构计划
- **技术选型**: 合理的技术选型
- **文档更新**: 及时更新技术文档

**文档版本**: 1.0
**创建时间**: 2026-02-08
**最后更新**: 2026-02-08 23:57:00