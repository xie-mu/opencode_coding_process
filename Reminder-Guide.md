# OpenClaw 定时提醒指南

## 概述

OpenClaw 提供了两种主要的定时提醒机制：**心跳（Heartbeat）** 和 **定时任务（Cron）**。本文档将帮助您选择最适合的提醒方式。

## 快速决策指南

| 使用场景 | 推荐方式 | 原因 |
|---------|---------|------|
| 每30分钟检查收件箱 | 心跳 | 批量处理，上下文感知 |
| 每天早上9点发送报告 | 定时任务（隔离） | 精确时间需求 |
| 监控日历中的即将到来的事件 | 心跳 | 周期性监控的自然选择 |
| 每周深度分析 | 定时任务（隔离） | 独立任务，可使用不同模型 |
| 20分钟后提醒我 | 定时任务（主会话） | 一次性精确提醒 |

## 心跳机制（Heartbeat）

心跳是主会话中的周期性任务，默认每30分钟运行一次。

### 创建心跳任务

在 `HEARTBEAT.md` 文件中添加检查项：

```markdown
# HEARTBEAT.md - 心跳任务清单

## 日常检查
- 📧 检查邮箱中的紧急消息
- 📅 查看接下来2小时内的日历事件
- 🌤️ 获取天气信息（如果今天有户外活动计划）
- 📊 检查项目状态和进度

## 智能提醒
- 如果已经8小时以上没有活动，发送简短检查
- 如果有重要任务即将到期，提前提醒
- 如果有会议即将开始（<30分钟），发送提醒
```

### 配置心跳

```json5
{
  "agents": {
    "defaults": {
      "heartbeat": {
        "every": "30m", // 间隔时间
        "target": "last", // 提醒发送位置
        "activeHours": { // 可选：活跃时间段
          "start": "08:00",
          "end": "22:00"
        }
      }
    }
  }
}
```

### 心跳的优势

- **批量处理**：一个心跳可以处理多个检查任务
- **减少API调用**：比多个独立的定时任务更经济
- **上下文感知**：代理知道您最近的工作，可以智能优先处理
- **智能抑制**：如果没有重要事项，代理会回复 `HEARTBEAT_OK`，不发送消息
- **自然的时间安排**：根据队列负载略有延迟，对大多数监控任务足够

## 定时任务（Cron）

定时任务在精确的时间运行，可以在隔离会话中执行，不影响主会话上下文。

### 创建一次性提醒

```bash
# 5分钟后提醒喝水
openclaw cron add \
  --name "提醒喝水" \
  --at "5m" \
  --session isolated \
  --message "💧 该喝水啦！" \
  --deliver \
  --channel qqbot \
  --to "85EAAA7E3B6F73D23B4708739A38083F" \
  --delete-after-run
```

### 创建周期性提醒

```bash
# 每天早上8点提醒
openclaw cron add \
  --name "早晨提醒" \
  --cron "0 8 * * *" \
  --tz "Asia/Shanghai" \
  --session isolated \
  --message "🌅 早上好！今天有什么需要帮助的吗？" \
  --announce \
  --channel qqbot \
  --to "85EAAA7E3B6F73D23B4708739A38083F"
```

### 定时任务的参数说明

- `--at`: 一次性定时任务的触发时间
  - 相对时间格式：数字+单位，如 `5m`（5分钟）、`1h`（1小时）、`2d`（2天）
  - 绝对时间格式：ISO 8601 带时区，如 `2026-02-01T14:00:00+08:00`

- `--cron`: 周期性任务（cron表达式）
  - 格式：`分 时 日 月 星期`
  - 示例：`0 8 * * *`（每天早上8点）
  - 示例：`0 9 * * 1`（每周一早上9点）

- `--tz`: 时区设置（周期性任务必需）
  - 示例：`Asia/Shanghai`、`America/New_York`

- `--session`: 会话类型
  - `isolated`: 隔离会话，不影响主会话
  - `main`: 主会话，通过系统事件触发

- `--delete-after-run`: 一次性任务必须添加此参数

### 定时任务的优势

- **精确时间**：5字段cron表达式，支持时区
- **会话隔离**：在 `cron:<jobId>` 中运行，不污染主历史记录
- **模型覆盖**：可为每个任务使用不同的模型或思考级别
- **交付控制**：隔离任务默认使用 `announce`（摘要）；可选择 `none` 根据需要
- **立即交付**：公告模式直接发布，无需等待心跳
- **无需代理上下文**：即使主会话空闲或压缩也能运行
- **一次性支持**：`--at` 支持精确的未来时间戳

## 最佳实践

### 1. 混合使用心跳和定时任务

**HEARTBEAT.md**（每30分钟检查）：
```markdown
# 心跳检查清单

- 扫描邮箱中的紧急邮件
- 检查接下来2小时内的日历事件
- 查看任何待处理的任务
- 如果安静了8小时以上，发送简短检查
```

**定时任务**（精确时间安排）：
```bash
# 每日早上简报在7点
openclaw cron add --name "Morning brief" --cron "0 7 * * *" --session isolated --message "..." --announce

# 每周项目审查在周一早上9点
openclaw cron add --name "Weekly review" --cron "0 9 * * 1" --session isolated --message "..." --model opus

# 一次性提醒
openclaw cron add --name "Call back" --at "2h" --session main --system-event "Call back the client" --wake now
```

### 2. 选择合适的会话类型

**使用主会话定时任务**：
- 当提醒需要出现在主会话上下文中
- 代理可以在下一个心跳中处理它，具有完整上下文
- 不需要独立的隔离运行

**使用隔离会话定时任务**：
- 当需要一个干净的画布，没有之前的上下文
- 使用不同的模型或思考设置
- 直接发布摘要到通道
- 历史记录不会干扰主会话

### 3. 成本控制

- 保持 `HEARTBEAT.md` 简洁，以最小化标记开销
- 将类似的检查批处理到心跳中，而不是多个定时任务
- 在心跳上使用 `target: "none"` 如果您只想进行内部处理
- 为常规任务在隔离定时任务中使用更便宜的模型

## 故障排除

### 常见问题

1. **定时任务没有运行**
   - 检查cron表达式是否正确
   - 验证时区设置
   - 查看日志文件：`tail -f /tmp/openclaw/openclaw-*.log`

2. **心跳没有触发**
   - 检查 `HEARTBEAT.md` 文件是否存在且非空
   - 验证心跳间隔配置
   - 确保代理正在运行

3. **消息没有送达**
   - 检查通道配置
   - 验证目标地址是否正确
   - 确认 `--delete-after-run` 用于一次性任务

### 调试命令

```bash
# 查看定时任务列表
openclaw cron list

# 查看特定任务的运行历史
openclaw cron runs <jobId>

# 立即运行任务
openclaw cron run <jobId>

# 删除任务
openclaw cron remove <jobId>
```

## 安全注意事项

1. **一次性任务**：始终使用 `--delete-after-run` 参数，避免重复提醒
2. **敏感信息**：不要在提醒消息中包含敏感数据
3. **频率控制**：避免过于频繁的提醒，造成骚扰
4. **权限管理**：确保只有授权用户可以创建或管理提醒

## 示例配置

### 完整的提醒系统配置

```json5
{
  "agents": {
    "defaults": {
      "heartbeat": {
        "every": "30m",
        "target": "last",
        "activeHours": {
          "start": "08:00",
          "end": "22:00"
        }
      }
    }
  },
  "channels": {
    "qqbot": {
      "allowFrom": ["85EAAA7E3B6F73D23B4708739A38083F"]
    }
  }
}
```

### HEARTBEAT.md 示例

```markdown
# 心跳检查清单

## 日常任务
- 📧 检查邮箱中的重要邮件（2小时内回复）
- 📅 查看日历中的即将到来的事件
- 💧 如果已经2小时没有活动，提醒喝水
- 📊 检查项目进度和截止日期

## 智能提醒
- 如果会议在30分钟内开始，发送提醒
- 如果有重要任务即将到期，提前通知
- 如果已经8小时以上没有活动，发送简短问候
- 如果有新的紧急消息，立即通知

## 健康提醒
- 每小时提醒休息眼睛
- 每2小时提醒活动身体
- 晚上提醒准备明天的事项
```

---

**记住：选择合适的提醒机制，让AI助手更好地为您服务！**